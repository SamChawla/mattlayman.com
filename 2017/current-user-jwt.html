<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel='stylesheet' href='/screen.css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin:600|Lora:400,700'
    rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <title>A currentUser service for Ember with JWT - mattlayman.com</title>
  <meta name='viewport' content='width=device-width' />
  <meta property="og:type" content="article" />
<meta property="og:url" content="http://www.mattlayman.com/2017/current-user-jwt.html" />
<meta property="og:image" content="http://www.mattlayman.com/2017/jwt.svg" />
<meta property="og:title" content="A currentUser service for Ember with JWT" />
<meta property="og:description" content="As a user of Ember Simple Auth and Ember Simple Auth Token, I needed to show an authenticated user for College Conductor. By making a currentUser service, my application could access the user. Since College Conductor uses JWT, making the service required some extra thought. Check out how it works!" />
  <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@mblayman" />
<meta name="twitter:image" content="http://www.mattlayman.com/2017/jwt.svg" />
<meta name="twitter:title" content="A currentUser service for Ember with JWT" />
<meta name="twitter:description" content="As a user of Ember Simple Auth and Ember Simple Auth Token, I needed to show an authenticated user for College Conductor. By making a currentUser service, my application could access the user. Since College Conductor uses JWT, making the service required some extra thought. Check out how it works!" />
  <link rel='alternate' href='/feed.xml' title="Matt Layman's Writings"
    type='atom+xml'>
  <script src="//load.sumome.com/" data-sumo-site-id="bebd12621ec197c6697df2c9248f3a0e593a38b2eae32e10899930dae8668b9a" async="async"></script>
</head>
<body lang='en'>
<div id='container'>
  <h1>A currentUser service for Ember with JWT</h1>
<p class='byline'>By <a href='/'>Matt Layman</a> on January 31, 2017</p>
<p><img class='book mv20' src='jwt.svg'></p>
<p>Any Software as a Service will likely need
the capability to authenticate a user
and show information
about that user.
As an interesting design choice,
<a href="http://emberjs.com/">Ember</a> does <strong>not</strong>
include authentication
as a core feature.
Instead,
Ember developers must turn to the addon ecosystem.
After some research,
I chose
<a href="http://ember-simple-auth.com/">Ember Simple Auth</a>
with
<a href="https://github.com/jpadilla/ember-simple-auth-token">Ember Simple Auth Token</a>
to use
JSON Web Tokens (<a href="https://jwt.io/">JWT</a>)
for <a href="https://www.collegeconductor.com">College Conductor</a>.
JSON Web Tokens are an emerging standard
that make secure exchanges (like authentication) possible.
To provide user information
throughout the application,
I had to do some extra work
to create an Ember
<a href="https://guides.emberjs.com/v2.11.0/applications/services/">service</a>.
I&rsquo;m going to cover what I learned
in the process.</p>
<p>Thankfully for me (and you),
Ember Simple Auth has good documentation
to cover a wide variety
of uses.
As a template,
I used the
<a href="https://github.com/simplabs/ember-simple-auth/blob/master/guides/managing-current-user.md">Managing a Current User</a>
guide
to direct the service
that I needed.
This guide lays out the structure required
to extract information
from the <code>session</code> service provided
by Ember Simple Auth.</p>
<p>Generating a service to start is one command away:</p>
<div class="codehilite"><pre><span></span>$ ember generate service current-user
</pre></div>


<p>We can begin by looking
at the code
in the Ember Simple Auth guide.</p>
<div class="codehilite"><pre><span></span><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">inject</span><span class="o">:</span> <span class="p">{</span> <span class="nx">service</span> <span class="p">},</span> <span class="nx">isEmpty</span><span class="p">,</span> <span class="nx">RSVP</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Service</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">session</span><span class="o">:</span> <span class="nx">service</span><span class="p">(</span><span class="s1">&#39;session&#39;</span><span class="p">),</span>
  <span class="nx">store</span><span class="o">:</span> <span class="nx">service</span><span class="p">(),</span>

  <span class="nx">load</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session.data.authenticated.user_id&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">userId</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">).</span><span class="nx">findRecord</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">RSVP</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>


<p>This service is almost exactly what we need
but there is a problem.
When using JWT,
the data stored in the session is an encoded token.
The service needs to get the user ID
and it&rsquo;s not easily accessible.
That leads to code like:</p>
<div class="codehilite"><pre><span></span><span class="kr">import</span> <span class="nx">Ember</span> <span class="nx">from</span> <span class="s1">&#39;ember&#39;</span><span class="p">;</span>

<span class="kr">const</span> <span class="p">{</span> <span class="nx">inject</span><span class="o">:</span> <span class="p">{</span> <span class="nx">service</span> <span class="p">},</span> <span class="nx">isEmpty</span><span class="p">,</span> <span class="nx">RSVP</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">Ember</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="nx">Ember</span><span class="p">.</span><span class="nx">Service</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
  <span class="nx">session</span><span class="o">:</span> <span class="nx">service</span><span class="p">(),</span>
  <span class="nx">store</span><span class="o">:</span> <span class="nx">service</span><span class="p">(),</span>

  <span class="nx">load</span><span class="p">()</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;session.data.authenticated.token&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">token</span><span class="p">))</span> <span class="p">{</span>
<span class="hll">      <span class="kr">const</span> <span class="nx">userId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
</span>      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;store&#39;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">userId</span><span class="p">).</span><span class="nx">then</span><span class="p">((</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">RSVP</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">},</span>

<span class="hll">  <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="c1">// What goes here?</span>
</span><span class="hll">    <span class="k">return</span> <span class="mi">42</span><span class="p">;</span>
</span><span class="hll">  <span class="p">}</span>
</span><span class="p">});</span>
</pre></div>


<p>As I explored the source code,
I discovered that the session did not store the decoded token data.
I had to find a way to decode the token
so I could extract the <code>user_id</code>
that my API provided.
The JWT authenticator
in Ember Simple Auth Token
included what I needed.
Ember Simple Auth does not expose
a method to get the authenticator
(please prove me wrong!)
so I opted to create an instance myself
and invoke its <code>getTokenData</code> method.</p>
<p>The result looks like:</p>
<div class="codehilite"><pre><span></span><span class="kr">import</span> <span class="nx">JWT</span> <span class="nx">from</span> <span class="s1">&#39;ember-simple-auth-token/authenticators/jwt&#39;</span><span class="p">;</span>

<span class="o">&lt;</span><span class="nx">snip</span><span class="o">&gt;</span>

  <span class="nx">getUserIdFromToken</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">JWT</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">tokenData</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">getTokenData</span><span class="p">(</span><span class="nx">token</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">tokenData</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">];</span>
  <span class="p">}</span>
</pre></div>


<p>If I reflect on what I had to do,
I think it is safe to state
that the final change was not too difficult.
The part that I find interesting is
that I had to be comfortable digging through the source code
of Ember Simple Auth Token.</p>
<h2>Reading other source code is a needed developer skill.</h2>
<p>Last week,
I wrote about
<a href="/2017/necessity-of-software-abstraction.html">software abstractions</a>
and the benefits of boundaries.
The boundaries provided by abstractions are extremely useful,
but we should be comfortable breaking through them
when it seems like there are no options.
Reading the source code
of third party addons, extensions, plugins,
and the like
is a useful tool
that can often make quick work
of a tricky problem.</p>
<p>If you want to chat about this with me, I'm
  <a href="https://twitter.com/mblayman">@mblayman</a> on Twitter.</p>
  <br>
  <footer>
    <p><img alt='Creative Commons Attribution 4.0 International License'
      src='/cc.png' width='80' height='15'> <a href='/'> Matt Layman</a>,
      2017</p>
  </footer>
</div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-93541554-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html><!-- handrolled for excellence -->
