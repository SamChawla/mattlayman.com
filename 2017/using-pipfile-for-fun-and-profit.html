<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel='stylesheet' href='/screen.css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin:600|Lora:400,700'
    rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <title>Using Pipfile for fun and profit - mattlayman.com</title>
  <meta name='viewport' content='width=device-width' />
  <meta property="og:type" content="article" />
<meta property="og:url" content="http://www.mattlayman.com/2017/using-pipfile-for-fun-and-profit.html" />
<meta property="og:image" content="http://www.mattlayman.com/images/python.png" />
<meta property="og:title" content="Using Pipfile for fun and profit" />
<meta property="og:description" content="Python has many methods to manage software package dependencies. The Python Packaging Authority proposed a new standard format called a Pipfile. Let's explore the reasons and benefits of a Pipfile and walk through converting a project to use one." />
  <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@mblayman" />
<meta name="twitter:image" content="http://www.mattlayman.com/images/python.png" />
<meta name="twitter:title" content="Using Pipfile for fun and profit" />
<meta name="twitter:description" content="Python has many methods to manage software package dependencies. The Python Packaging Authority proposed a new standard format called a Pipfile. Let's explore the reasons and benefits of a Pipfile and walk through converting a project to use one." />
  <link rel='alternate' href='/feed.xml' title="Matt Layman's Writings"
    type='atom+xml'>
  <script src="//load.sumome.com/" data-sumo-site-id="bebd12621ec197c6697df2c9248f3a0e593a38b2eae32e10899930dae8668b9a" async="async"></script>
</head>
<body lang='en'>
<div id='container'>
  <h1>Using Pipfile for fun and profit</h1>
<p class='byline'>By <a href='/'>Matt Layman</a> on July 4, 2017</p>
<p><img class='book' src='/images/python.png'></p>
<p><strong>Managing dependencies is deceptively hard.</strong>
Need proof?
Talk to anyone who has to manage a <code>package.json</code>
in JavaScript.
I&rsquo;m sure they&rsquo;ll have stories.</p>
<p>Python is not immune to this hard problem.
For years, the community rallied around the <code>requirements.txt</code> file
to manage dependencies,
but there are some subtle flaws
that make dependency handling more confusing
than necessary.
To fix these issues,
the <a href="https://github.com/pypa">Python Packaging Authority</a>,
which is the group responsible
for many things including <code>pip</code> and <a href="https://pypi.python.org/pypi">PyPI</a>,
proposed a replacement for <code>requirements.txt</code>
called a <code>Pipfile</code>.
<em>We&rsquo;re going to look
at the two file formats
to see why a <code>Pipfile</code> is a better fit
for the community
in the future
and how you can get started using one.</em></p>
<h2>requirements.txt</h2>
<p>Let&rsquo;s look at <code>requirements.txt</code> to see
where the flaws are.</p>
<p>A <code>requirements.txt</code> file has a very primitive structure.
Here&rsquo;s a sample file from the <a href="https://github.com/handroll/handroll">handroll</a> project
that I work on.</p>
<div class="codehilite"><pre><span></span>Jinja2==2.8
Markdown==2.4
MarkupSafe==0.23
PyYAML==3.11
Pygments==2.1.3
Werkzeug==0.11.4
argh==0.26.1
argparse==1.2.1
blinker==1.4
docutils==0.12
mock==1.0.1
pathtools==0.1.2
textile==2.2.2
watchdog==0.8.3
</pre></div>


<p>The core requirement is that
each line in the file specifies one dependency.</p>
<p>The example adds a version specifier
for each package
even though that is not required.
The file could have said <code>Jinja2</code> instead of <code>Jinja2==2.8</code>.
In that small detail,
we can begin to see weaknesses in the structure.
Which is more correct, to specify versions or not?
<em>It depends.</em></p>
<p>Specifying the version of a package is called <em>pinning</em>.
Files that pin versions for <em>every</em> dependency
make it possible to reproduce the environment.
This quality is very valuable for operating
in a production scenario.</p>
<p><strong>What&rsquo;s the downside?</strong>
It&rsquo;s very hard to determine which packages are the direct dependencies.
For instance, handroll directly uses <code>Jinja2</code>,
but <code>MarkupSafe</code> is only listed
because it is a dependency of a dependency.
<code>Jinja2</code> depends on <code>MarkupSafe</code>.
Thus, <code>MarkupSafe</code> is a <em>transitive dependency</em>
of handroll.</p>
<p>The reason to include the transitive dependency
comes back to reproducing the environment.
If we only listed <code>Jinja2</code>,
it&rsquo;s possible for an updated version
of <code>MarkupSafe</code> to be installed
that could break handroll.
That leads to a bad user experience.</p>
<p>We&rsquo;ve reached the core problem
of the older format:
<em><code>requirements.txt</code> is attempting to be two views of dependencies.</em></p>
<ol>
<li>A pinned <code>requirements.txt</code> acts as a manifest
   to reproduce the operating environment.</li>
<li>An unpinned <code>requirements.txt</code> acts as the logical list
   of dependencies that a package depends on.</li>
</ol>
<p>There is also a secondary problem related to the audience.
If I&rsquo;m a user of handroll,
I only care about the dependencies that make the tool work.
If I&rsquo;m a developer for handroll,
I <em>also</em> would like the tools needed for development
(e.g., a linter, translation tools, upload tools for PyPI).</p>
<p>At this stage, conventions begin to break down
in the community.
Some projects use a <code>requirements-dev.txt</code> file
for developer-only dependencies.
Others opt for a <code>requirements</code> directory
that contain many different files
of dependencies.
Both are imperfect solutions.</p>
<p>We&rsquo;re now positioned to consider what a <code>Pipfile</code>
brings to the problem.</p>
<h2>Pipfile</h2>
<p>A <code>Pipfile</code> handles the problems
that <code>requirements.txt</code> does not.
It is important to note that a <code>Pipfile</code> is <em>not</em> a novel creation.
Pipfile is a Python implementation of a system that appears
in Ruby, Rust, PHP, and JavaScript.
<a href="http://bundler.io/">Bundler</a>,
<a href="https://crates.io/">Cargo</a>,
<a href="https://getcomposer.org/">Composer</a>,
and <a href="https://yarnpkg.com/en/">Yarn</a>
are tools
from each of those languages
that follow a similar pattern.
<em>What traits do these systems have in common?</em></p>
<ol>
<li>Split logical dependencies and a dependency manifest
   into separate files.</li>
<li>Separate the sections for user
   and developer dependencies.</li>
</ol>
<h3><code>Pipfile</code> and <code>Pipfile.lock</code></h3>
<p>The <code>Pipfile</code> manages the logical dependencies
of a project.
When I write &ldquo;logical,&rdquo;
I&rsquo;m referring to the dependencies
that a project directly
depends on
in its code.
One way to think about the logical dependencies
is as the set of dependencies
<strong>excluding</strong> the transitive dependencies.</p>
<p>Conversely,
a <code>Pipfile.lock</code> is the set
of dependencies
<strong>including</strong> the transitive dependencies.
This file acts as the dependency manifest
to use when building an environment
for a production setting.</p>
<blockquote>
<p>The <code>Pipfile</code> is for people. The <code>Pipfile.lock</code> is for computers.</p>
</blockquote>
<p>Having a clear distinction between files
offers a couple of benefits.</p>
<ol>
<li>People can read and reason about the <code>Pipfile</code>.
   There is no need to guess if a dependency is a direct dependency
   of a project.</li>
<li>Extra metadata can be stored in the <code>Pipfile.lock</code>.
   The metadata can include things like <code>sha256</code> checksums
   that help verify the integrity
   of a package&rsquo;s content.</li>
</ol>
<h3>Users and developers</h3>
<p>The other trait of a <code>Pipfile</code> is the split
between user and developer dependencies.
Let&rsquo;s look at the <code>Pipfile</code>
for <a href="https://github.com/python-tap/pytest-tap">pytest-tap</a>,
a project that I converted recently to the <code>Pipfile</code> format.</p>
<div class="codehilite"><pre><span></span><span class="k">[[source]]</span>
<span class="na">url</span> <span class="o">=</span> <span class="s">&quot;https://pypi.python.org/simple&quot;</span>
<span class="na">verify_ssl</span> <span class="o">=</span> <span class="s">true</span>

<span class="k">[dev-packages]</span>
<span class="na">babel</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">flake8</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">mock</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">requests</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">tox</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">twine</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>

<span class="k">[packages]</span>
<span class="na">pytest</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
<span class="na">&quot;tap.py&quot;</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</pre></div>


<p>Because <code>Pipfile</code> uses <a href="https://github.com/toml-lang/toml">TOML</a>,
it can include sections
when a <code>requirements.txt</code> file could not.
The sections give a clear delineation
between user packages and developer packages.</p>
<p>pytest-tap is <a href="https://docs.pytest.org/en/latest/">pytest</a> plugin
that produces <a href="http://testanything.org/">Test Anything Protocol (TAP)</a> output.
It is a natural fit to depend on <code>pytest</code>
and <code>tap.py</code>, a TAP library.</p>
<p>The other dependencies do developer specific things.
<code>tox</code> and <code>mock</code> help with test execution,
<code>twine</code> is for uploading the package to PyPI,
and so on.</p>
<p>I hope that you could have an intuition
about pytest-tap dependencies
even without my prose descriptions.
Additionally,
splitting things out permits regular users
to skip installing extra packages.
That&rsquo;s the power
of a <code>Pipfile</code>.</p>
<h3>pipenv</h3>
<p>Now that we&rsquo;ve covered the benefits,
<em>how do you create a <code>Pipfile</code>
for your own project?</em>
Enter pipenv.</p>
<p>Kenneth Reitz, of <code>requests</code> fame,
created <a href="http://docs.pipenv.org/en/latest/">pipenv</a>,
a tool to manage a <code>Pipfile</code>.
pipenv helps users add and remove packages
from their <code>Pipfile</code> (and <code>Pipfile.lock</code>)
in conjunction
with a virtual environment.</p>
<p>Rather than manipulating a virtual environment and pip directly,
you use the <code>pipenv</code> command,
and it will do the work for you.
If you come from the Ruby world,
this is very similar to <code>bundle</code>.</p>
<p>Suppose you have a project
that depends
on Django.
You could prepare your Django project
with these commands:</p>
<div class="codehilite"><pre><span></span>$ pipenv --three
$ pipenv install Django
$ pipenv lock
</pre></div>


<p>Those steps would:</p>
<ul>
<li>create a Python 3 virtual environment</li>
<li>install Django and add it to a <code>Pipfile</code></li>
<li>generate a <code>Pipfile.lock</code></li>
</ul>
<p>Once the files are created,
you can share your work,
and others should be able to recreate your environment.</p>
<h3>Summary</h3>
<p><code>Pipfile</code> is still an emerging standard.
In spite of that,
it is very promising
and solves some problems
that arise when working
with packages.
We saw how <code>Pipfile</code> beats out the venerable <code>requirements.txt</code> file,
and we&rsquo;re equipped with pipenv
to make <code>Pipfile</code>s for our projects.</p>
<p>I hope you learned something
about Python dependencies
and the brighter future
that is accessible today.</p>
<p>If you want to chat about this with me, I'm
  <a href="https://twitter.com/mblayman">@mblayman</a> on Twitter.</p>

<br>

<h2>Matt Layman</h2>

<div id='me-wrapper'>
<img id='me' src='/photo.jpg' width='120' height='120'>
</div>

<p>
  Matt is the lead software engineer at
  <a href="https://storybird.com" target="_blank">Storybird</a>.
</p>
<p>
  Always eager to talk about Python
  and other technology topics,
  Matt organizes
  <a href="https://www.meetup.com/python-frederick/" target="_blank">Python Frederick</a>
  in Frederick, Maryland (NW of Washington D.C.)
  and seeks to grow software skills
  for people in his community.
</p>
  <br>
  <footer>
    <p><img alt='Creative Commons Attribution 4.0 International License'
      src='/cc.png' width='80' height='15'> <a href='/'> Matt Layman</a>,
      2017</p>
  </footer>
</div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-93541554-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html><!-- handrolled for excellence -->
