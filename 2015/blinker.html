<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel='stylesheet' href='/screen.css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin:600|Lora:400,700'
    rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <title>Connect Python objects to blinker signals - mattlayman.com</title>
  <meta name='viewport' content='width=device-width' />
  <meta property="og:type" content="article" />
<meta property="og:url" content="http://www.mattlayman.com/2015/blinker.html" />
<meta property="og:image" content="http://www.mattlayman.com/2015/blinker.png" />
<meta property="og:title" content="Connect Python objects to blinker signals" />
<meta property="og:description" content="Do you need a way to trigger some Python code to run when a certain event happens? Blinker is a Python package that makes this kind of feature possible with something called signals. Learn how to connect Python objects to blinker signals." />
  <meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@mblayman" />
<meta name="twitter:image" content="http://www.mattlayman.com/2015/blinker.png" />
<meta name="twitter:title" content="Connect Python objects to blinker signals" />
<meta name="twitter:description" content="Do you need a way to trigger some Python code to run when a certain event happens? Blinker is a Python package that makes this kind of feature possible with something called signals. Learn how to connect Python objects to blinker signals." />
  <link rel='alternate' href='/feed.xml' title="Matt Layman's Writings"
    type='atom+xml'>
  <script src="//load.sumome.com/" data-sumo-site-id="bebd12621ec197c6697df2c9248f3a0e593a38b2eae32e10899930dae8668b9a" async="async"></script>
</head>
<body lang='en'>
<div id='container'>
  <h1>Connect Python objects to blinker signals</h1>
<p class='byline'>By <a href='/'>Matt Layman</a> on March 18, 2015</p>
<p><img class='book' src='blinker.png'></p>
<p>I started using <a href="https://pythonhosted.org/blinker/">blinker</a> for <a href="http://handroll.github.io/">handroll</a>.
Blinker is a signal generation library for broadcasting events.
The library lets signalers send messages
to connected receiver functions.
I will explain how I convinced Blinker to talk to objects
instead of pure Python functions.</p>
<p>The example code is going to handle a &ldquo;<a href="http://dictionary.reference.com/browse/frobnicate">frobnicated</a>&rdquo; signal.
Remember, the signal itself is not very important.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">blinker</span>

<span class="n">frobnicated</span> <span class="o">=</span> <span class="n">blinker</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="s1">&#39;frobnicated&#39;</span><span class="p">)</span>
</pre></div>


<p><code>frobnicated</code> is a named signal.
In a real project,
you might put all your signals in a single module.
<a href="https://github.com/getpelican/pelican/blob/master/pelican/signals.py">Pelican</a> does this nicely.
Grouping all your signals in one place
gives signal consumers a clear view of what is available.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">Receiver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">handle_frobnicated</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">on_frobnicated</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handle_frobnicated</span> <span class="o">=</span> <span class="n">handle_frobnicated</span>
        <span class="n">frobnicated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handle_frobnicated</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_frobnicated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">sender</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
</pre></div>


<p>The <code>__init__</code> method is where all the magic happens.
The first thing to notice is the use of an inner function,
<code>handle_frobnicated</code>.
The inner function uses the method signature
that the signal will invoke,
and delegates to <code>Receiver.on_frobnicated</code>.
Why?
This is necessary
because Blinker can&rsquo;t pass <code>self</code> to receiver functions.
<code>handle_frobnicated</code> acts as a <a href="http://en.wikipedia.org/wiki/Closure_%28computer_programming%29">closure</a> on <code>self</code>
which lets the signal call the instance method.</p>
<div class="codehilite"><pre><span></span>        <span class="bp">self</span><span class="o">.</span><span class="n">handle_frobnicated</span> <span class="o">=</span> <span class="n">handle_frobnicated</span>
</pre></div>


<p>That seems like a strange line,
doesn&rsquo;t it?
Blinker does some funny stuff with references.
Without storing the inner function,
Blinker will delete a weak function reference
and the inner function will no longer be among the signal&rsquo;s receivers.
I stared at the Blinker source code
for a long time
to figure that mystery out.</p>
<p>The last line in <code>__init__</code> connects the signal to the inner function.
The receiver is ready to handle <code>frobnicated</code> events.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">receiver</span> <span class="o">=</span> <span class="n">Receiver</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">frobnicated</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;Sender </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>


<p>The code to fire the signal is fairly boring.
Notice that <code>frobnicated.send</code> has no need for <code>receiver</code>.
The publisher is disconnected from subscriber at this stage.
The final result looks like:</p>
<div class="codehilite"><pre><span></span><span class="gp">$</span> python blink_object.py
<span class="go">Sender 0 hello</span>
<span class="go">Sender 1 hello</span>
<span class="go">Sender 2 hello</span>
<span class="go">Sender 3 hello</span>
<span class="go">Sender 4 hello</span>
<span class="go">Sender 5 hello</span>
<span class="go">Sender 6 hello</span>
<span class="go">Sender 7 hello</span>
<span class="go">Sender 8 hello</span>
<span class="go">Sender 9 hello</span>
</pre></div>


<p>By connecting a signal to an object,
you get all the benefits that come along with classes.
Rather than making a monsterous function,
you could use various instance methods
within the handler.
This flexibility is a boon for unit testing.
The gain has similar advantages to using <a href="https://docs.djangoproject.com/en/1.7/topics/class-based-views/intro/">class based views</a>
in Django
rather than function views.</p>
<p>You can <a href="blink_object.py">check out the full example in all its glory.</a></p>
<p>If you want to chat about this with me, I'm
  <a href="https://twitter.com/mblayman">@mblayman</a> on Twitter.</p>

<br>

<h2>Matt Layman</h2>

<div id='me-wrapper'>
<img id='me' src='/photo.jpg' width='120' height='120'>
</div>

<p>
  Matt is the lead software engineer at
  <a href="https://storybird.com" target="_blank">Storybird</a>.
</p>
<p>
  Always eager to talk about Python
  and other technology topics,
  Matt organizes
  <a href="https://www.meetup.com/python-frederick/" target="_blank">Python Frederick</a>
  in Frederick, Maryland (NW of Washington D.C.)
  and seeks to grow software skills
  for people in his community.
</p>
  <br>
  <footer>
    <p><img alt='Creative Commons Attribution 4.0 International License'
      src='/cc.png' width='80' height='15'> <a href='/'> Matt Layman</a>,
      2017</p>
  </footer>
</div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-93541554-1', 'auto');
    ga('send', 'pageview');

  </script>
</body>
</html><!-- handrolled for excellence -->
